<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory Management System</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --text:#e9efff;
      --muted:#aab6df;
      --brand:#6aa6ff;
      --ok:#3ddc97;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --line:rgba(255,255,255,.08);
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius: 16px;
      --radius2: 12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 800px at 20% -10%, rgba(106,166,255,.25), transparent 55%),
                  radial-gradient(1000px 700px at 110% 30%, rgba(61,220,151,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .app{
      display:grid;
      grid-template-columns: 280px 1fr;
      min-height:100vh;
    }
    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 30%),
                  var(--panel2);
      border-right: 1px solid var(--line);
      padding: 18px 14px;
      position: sticky;
      top:0;
      height: 100vh;
      overflow:auto;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 10px 14px;
      margin-bottom: 10px;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(106,166,255,.9), rgba(61,220,151,.6));
      box-shadow: var(--shadow);
    }
    .brand h1{
      font-size: 16px; margin:0; letter-spacing:.2px;
    }
    .brand p{
      margin:2px 0 0; font-size:12px; color:var(--muted);
    }
    .nav{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding: 8px;
    }
    .nav button{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
      border:1px solid transparent;
      background: transparent;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      text-align:left;
      transition:.12s ease;
      font-size:14px;
    }
    .nav button:hover{ background: rgba(255,255,255,.04); }
    .nav button.active{
      background: rgba(106,166,255,.13);
      border-color: rgba(106,166,255,.25);
    }
    .nav .icon{ width:22px; opacity:.95; display:inline-flex; justify-content:center; }
    .side-footer{
      margin-top: 16px;
      padding: 12px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
    }
    .main{
      padding: 22px 22px 40px;
      overflow:auto;
    }
    .topbar{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 16px;
    }
    .title h2{margin:0;font-size:20px}
    .title p{margin:4px 0 0;color:var(--muted);font-size:13px}
    .actions{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .search{
      display:flex; align-items:center; gap:10px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      padding: 10px 12px;
      border-radius: 999px;
      min-width: 280px;
    }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: 14px;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition:.12s ease;
      font-weight:600;
      font-size: 13px;
    }
    .btn:hover{ background: rgba(255,255,255,.06); }
    .btn.primary{
      background: rgba(106,166,255,.18);
      border-color: rgba(106,166,255,.28);
    }
    .btn.primary:hover{ background: rgba(106,166,255,.24); }
    .btn.danger{
      background: rgba(255,107,107,.12);
      border-color: rgba(255,107,107,.20);
    }
    .btn.ghost{
      background: transparent;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items:start;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 26%),
                  rgba(255,255,255,.02);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 10px 32px rgba(0,0,0,.28);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd h3{margin:0;font-size:14px}
    .card .hd .sub{color:var(--muted);font-size:12px}
    .card .bd{padding: 14px}
    .kpi-row{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 14px;
    }
    .kpi{
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
    }
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:20px;font-weight:800;margin-top:6px}
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,255,255,.03);
    }
    .badge.ok{ color: rgba(61,220,151,.95); border-color: rgba(61,220,151,.25); background: rgba(61,220,151,.08);}
    .badge.warn{ color: rgba(255,204,102,.98); border-color: rgba(255,204,102,.22); background: rgba(255,204,102,.08);}
    .badge.bad{ color: rgba(255,107,107,.98); border-color: rgba(255,107,107,.22); background: rgba(255,107,107,.08);}

    table{
      width:100%;
      border-collapse:collapse;
      font-size: 13px;
    }
    th,td{
      padding: 10px 8px;
      border-bottom: 1px solid var(--line);
      vertical-align:middle;
    }
    th{
      text-align:left;
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
      letter-spacing:.2px;
    }
    tr:hover td{ background: rgba(255,255,255,.02); }
    .row-actions{
      display:flex; gap:6px; justify-content:flex-end;
    }
    .mini{
      padding: 7px 9px;
      border-radius: 10px;
      font-size: 12px;
    }
    .muted{ color: var(--muted); }
    .two-col{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom: 10px;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    .field input, .field select, .field textarea{
      background: rgba(255,255,255,.03);
      border: 1px solid var(--line);
      color: var(--text);
      padding: 10px 10px;
      border-radius: 12px;
      outline:none;
      font-size: 14px;
    }
    .field textarea{ min-height: 80px; resize: vertical; }
    .hint{ color: var(--muted); font-size: 12px; margin-top: 2px; }
    .line-items{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .li{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      background: rgba(255,255,255,.02);
      display:grid;
      grid-template-columns: 1.2fr .5fr .5fr auto;
      gap: 8px;
      align-items:end;
    }
    .li .field{ margin-bottom: 0; }
    .li .remove{ justify-self:end; }
    .toast{
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: rgba(17,26,51,.92);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 12px;
      box-shadow: var(--shadow);
      max-width: 360px;
      display:none;
      z-index: 9999;
    }
    .toast.show{display:block}
    .toast .t{font-weight:800;margin:0 0 4px}
    .toast .m{margin:0;color:var(--muted);font-size:13px}
    .empty{
      padding: 14px;
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 14px;
      color: var(--muted);
      background: rgba(255,255,255,.02);
      font-size: 13px;
    }
    .split{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .right{ text-align:right; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      font-size: 12px;
    }
    .hr{ height:1px; background: var(--line); margin: 12px 0; }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .grid{ grid-template-columns: 1fr; }
      .search{ min-width: 200px; flex: 1; }
      .kpi-row{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Inventory System</h1>
        <p>Supply ‚Ä¢ Sell ‚Ä¢ Manage</p>
      </div>
    </div>

    <div class="nav" id="nav">
      <button data-view="dashboard" class="active"><span class="icon">üè†</span>Dashboard</button>
      <button data-view="inventory"><span class="icon">üì¶</span>Inventory</button>
      <button data-view="clients"><span class="icon">üë•</span>Clients</button>
      <button data-view="vendors"><span class="icon">üè≠</span>Vendors</button>
      <button data-view="supply"><span class="icon">‚¨áÔ∏è</span>Supply Orders</button>
      <button data-view="sales"><span class="icon">‚¨ÜÔ∏è</span>Sales</button>
      <button data-view="reports"><span class="icon">üìà</span>Reports</button>
    </div>

    <div class="side-footer">
      <div class="split">
        <span class="pill">Demo Mode</span>
        <span class="pill" id="dbStatus">SQLite Ready</span>
      </div>
      <div style="margin-top:10px;">
        Tip: Try "Supply Orders" then "Sales"
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="title">
        <h2 id="pageTitle">Dashboard</h2>
        <p id="pageSubtitle" class="muted">Overview at a glance</p>
      </div>

      <div class="actions">
        <div class="search">
          <span style="opacity:.85">üîé</span>
          <input id="globalSearch" placeholder="Search inventory..." />
        </div>
        <button class="btn" id="seedBtn" title="Load demo data">Load Demo</button>
        <button class="btn danger" id="resetBtn" title="Clear all data">Reset</button>
      </div>
    </div>

    <div id="view"></div>
  </main>
</div>

<div class="toast" id="toast">
  <p class="t" id="toastTitle">Saved</p>
  <p class="m" id="toastMsg">Done.</p>
</div>
<script>
/**
 * frontend/index.html (refactored)
 * - No demo DB
 * - Uses backend API (/api/*) backed by SQLite
 * - Works when served from http://localhost:3000 OR opened as file:// (falls back to localhost)
 *
 * Assumes backend endpoints from your README:
 *  - /api/health
 *  - /api/inventory, /api/inventory/low-stock, /api/inventory/:id
 *  - /api/clients, /api/clients/:id
 *  - /api/vendors, /api/vendors/:id
 *  - /api/sales, /api/supply
 *  - /api/reports/dashboard (or /api/reports/inventory + /api/reports/transactions)
 */

// ============================
// Config
// ============================

const API_BASE = (() => {
  // If served by backend (http://localhost:3000), use same origin.
  // If opened as file://, use hard fallback to localhost.
  if (location.protocol === "file:") return "http://localhost:3000/api";
  return `${location.origin}/api`;
})();

// ============================
// Utilities
// ============================

function money(n) {
  const x = Number(n || 0);
  return x.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function safeInt(v, fallback = 0) {
  const n = Number.parseInt(v, 10);
  return Number.isFinite(n) ? n : fallback;
}

function safeFloat(v, fallback = 0) {
  const n = Number.parseFloat(v);
  return Number.isFinite(n) ? n : fallback;
}

function formatWhen(iso) {
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "";
  return d.toLocaleString(undefined, {
    year: "numeric",
    month: "short",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit"
  });
}

function esc(s) {
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#039;"
  }[c]));
}

function badgeForStock(q, threshold) {
  if (threshold == null) return `<span class="badge">Stock ${q}</span>`;
  if (q <= 0) return `<span class="badge bad">Out (${q})</span>`;
  if (q <= threshold) return `<span class="badge warn">Low (${q})</span>`;
  return `<span class="badge ok">OK (${q})</span>`;
}

// ============================
// Toast
// ============================

const toastEl = document.getElementById("toast");
function toast(title, msg) {
  document.getElementById("toastTitle").textContent = title;
  document.getElementById("toastMsg").textContent = msg;
  toastEl.classList.add("show");
  setTimeout(() => toastEl.classList.remove("show"), 2400);
}

// ============================
// API Client
// ============================

async function apiFetch(path, opts = {}) {
  const url = `${API_BASE}${path}`;
  const method = opts.method || "GET";
  const headers = { ...(opts.headers || {}) };

  let body = opts.body;
  if (body != null && typeof body === "object" && !(body instanceof FormData)) {
    headers["Content-Type"] = "application/json";
    body = JSON.stringify(body);
  }

  let res;
  try {
    res = await fetch(url, { method, headers, body });
  } catch (e) {
    // Network / server down
    throw new Error("Backend not reachable. Start the server (npm start).");
  }

  // Try parse JSON, but allow empty responses
  let data = null;
  const text = await res.text();
  if (text) {
    try { data = JSON.parse(text); } catch { data = text; }
  }

  if (!res.ok) {
    // Prefer server message if available
    const msg =
      (data && typeof data === "object" && (data.error || data.message)) ||
      (typeof data === "string" && data) ||
      `Request failed (${res.status})`;
    throw new Error(msg);
  }

  return data;
}

async function refreshHealth() {
  const el = document.getElementById("dbStatus");
  try {
    const h = await apiFetch("/health");
    el.textContent = (h && h.database === "connected") ? "API Connected" : "API Ready";
    el.classList.remove("badge", "bad", "warn", "ok");
    el.className = "pill";
  } catch (e) {
    el.textContent = "API Offline";
    // keep styling simple
  }
}

// ============================
// Cached State (client-side only)
// ============================

const state = {
  inventory: [],
  clients: [],
  vendors: [],
  sales: [],
  supply: [],
  lowStock: [],
  reports: {
    inventory: null,
    transactions: null,
    dashboard: null
  }
};

async function loadInventory() {
  state.inventory = await apiFetch("/inventory");
  return state.inventory;
}

async function loadLowStock() {
  // view is backed by SQLite view in your DB
  state.lowStock = await apiFetch("/inventory/low-stock");
  return state.lowStock;
}

async function loadClients() {
  state.clients = await apiFetch("/clients");
  return state.clients;
}

async function loadVendors() {
  state.vendors = await apiFetch("/vendors");
  return state.vendors;
}

async function loadSales() {
  state.sales = await apiFetch("/sales");
  return state.sales;
}

async function loadSupply() {
  state.supply = await apiFetch("/supply");
  return state.supply;
}

async function loadReports() {
  // Prefer dashboard endpoint if it exists
  try {
    state.reports.dashboard = await apiFetch("/reports/dashboard");
    return state.reports.dashboard;
  } catch {
    // fallback to separate endpoints if needed
    const inv = await apiFetch("/reports/inventory");
    const tx = await apiFetch("/reports/transactions");
    state.reports.dashboard = { inventory: inv, transactions: tx };
    return state.reports.dashboard;
  }
}

// ============================
// CRUD actions
// ============================

async function createInventoryItem(item) {
  return await apiFetch("/inventory", { method: "POST", body: item });
}

async function updateInventoryItem(id, item) {
  return await apiFetch(`/inventory/${id}`, { method: "PUT", body: item });
}

async function deleteInventoryItem(id) {
  return await apiFetch(`/inventory/${id}`, { method: "DELETE" });
}

async function createClient(client) {
  return await apiFetch("/clients", { method: "POST", body: client });
}

async function updateClient(id, client) {
  return await apiFetch(`/clients/${id}`, { method: "PUT", body: client });
}

async function deleteClient(id) {
  return await apiFetch(`/clients/${id}`, { method: "DELETE" });
}

async function createVendor(vendor) {
  return await apiFetch("/vendors", { method: "POST", body: vendor });
}

async function updateVendor(id, vendor) {
  return await apiFetch(`/vendors/${id}`, { method: "PUT", body: vendor });
}

async function deleteVendor(id) {
  return await apiFetch(`/vendors/${id}`, { method: "DELETE" });
}

async function createSupplyOrder(order) {
  return await apiFetch("/supply", { method: "POST", body: order });
}

async function createSale(sale) {
  return await apiFetch("/sales", { method: "POST", body: sale });
}

// ============================
// UI + Navigation
// ============================

const viewEl = document.getElementById("view");
const pageTitle = document.getElementById("pageTitle");
const pageSubtitle = document.getElementById("pageSubtitle");

function setPage(title, subtitle) {
  pageTitle.textContent = title;
  pageSubtitle.textContent = subtitle || "";
}

let currentView = "dashboard";

async function goto(view) {
  currentView = view;
  setActiveNav(view);

  const searchVal = document.getElementById("globalSearch").value || "";

  try {
    if (view === "dashboard") await renderDashboard();
    else if (view === "inventory") await renderInventory(searchVal);
    else if (view === "clients") await renderClients();
    else if (view === "vendors") await renderVendors();
    else if (view === "supply") await renderSupply();
    else if (view === "sales") await renderSales();
    else if (view === "reports") await renderReports();
  } catch (e) {
    toast("Error", e.message);
    // Keep user from seeing blank page on error
    viewEl.innerHTML = `<div class="empty">${esc(e.message)}</div>`;
  }
}

function setActiveNav(view) {
  document.querySelectorAll("#nav button").forEach(b => {
    b.classList.toggle("active", b.dataset.view === view);
  });
}

document.getElementById("nav").addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-view]");
  if (!btn) return;
  goto(btn.dataset.view);
});

document.getElementById("globalSearch").addEventListener("input", (e) => {
  const val = e.target.value;
  if (currentView === "inventory") renderInventory(val);
});

// ============================
// View Renderers (async)
// ============================

async function renderDashboard() {
  setPage("Dashboard", "Overview at a glance");

  // Load only what dashboard needs
  const [lowStock, sales, supply, invSummary] = await Promise.all([
    loadLowStock(),
    loadSales(),
    loadSupply(),
    (async () => {
      // Try reports first (fast), fallback to calc from inventory
      try {
        const r = await loadReports();
        if (r && r.total_value != null) return r; // if dashboard returns flat keys
        if (r && r.inventory) return r.inventory; // if dashboard returns nested
      } catch {}
      const inv = await loadInventory();
      const totalValue = inv.reduce((sum, i) => sum + (Number(i.quantity) * Number(i.unit_price)), 0);
      const totalItems = inv.reduce((sum, i) => sum + Number(i.quantity || 0), 0);
      return { total_value: totalValue, total_items: totalItems, low_stock_count: lowStock.length };
    })()
  ]);

  const recentSales = (sales || []).slice(0, 5);
  const recentSupply = (supply || []).slice(0, 5);

  viewEl.innerHTML = `
    <div class="kpi-row">
      <div class="kpi">
        <div class="label">Total Inventory Value</div>
        <div class="value">‚Ç¨${money(invSummary.total_value || 0)}</div>
      </div>
      <div class="kpi">
        <div class="label">Total Items in Stock</div>
        <div class="value">${safeInt(invSummary.total_items || 0, 0)}</div>
      </div>
      <div class="kpi">
        <div class="label">Low Stock Alerts</div>
        <div class="value">${lowStock.length}</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <h3>Low Stock Items</h3>
            <div class="sub">Items at or below reorder level</div>
          </div>
          <button class="btn mini primary" id="dashInvBtn">View All</button>
        </div>
        <div class="bd">
          ${lowStock.length ? `
            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Quantity</th>
                  <th>Reorder Level</th>
                </tr>
              </thead>
              <tbody>
                ${lowStock.slice(0, 5).map(item => `
                  <tr>
                    <td><strong>${esc(item.item_name)}</strong></td>
                    <td>${badgeForStock(Number(item.quantity), Number(item.reorder_level))}</td>
                    <td class="muted">${esc(item.reorder_level)}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          ` : `<div class="empty">No low stock alerts</div>`}
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <h3>Recent Activity</h3>
            <div class="sub">Latest transactions</div>
          </div>
        </div>
        <div class="bd">
          <h4 style="margin:0 0 8px;font-size:13px;">Recent Sales</h4>
          ${recentSales.length ? `
            <table style="margin-bottom:16px">
              <tbody>
                ${recentSales.map(sale => `
                  <tr>
                    <td class="muted" style="font-size:11px">${formatWhen(sale.sale_date)}</td>
                    <td>${esc(sale.client_name || "Walk-in")}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          ` : `<div class="empty" style="margin-bottom:16px">No sales yet</div>`}

          <h4 style="margin:0 0 8px;font-size:13px;">Recent Supply Orders</h4>
          ${recentSupply.length ? `
            <table>
              <tbody>
                ${recentSupply.map(order => `
                  <tr>
                    <td class="muted" style="font-size:11px">${formatWhen(order.order_date)}</td>
                    <td>${esc(order.vendor_name || "‚Äî")}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          ` : `<div class="empty">No supply orders yet</div>`}
        </div>
      </div>
    </div>
  `;

  document.getElementById("dashInvBtn").onclick = () => goto("inventory");
}

async function renderInventory(filter = "") {
  setPage("Inventory", "Manage your products");

  const inv = await loadInventory();

  const q = filter.trim().toLowerCase();
  const items = inv.filter(i => {
    if (!q) return true;
    return String(i.item_name || "").toLowerCase().includes(q)
      || String(i.description || "").toLowerCase().includes(q);
  });

  viewEl.innerHTML = `
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <h3>All Items</h3>
            <div class="sub">${items.length} items</div>
          </div>
          <button class="btn primary mini" id="addItemBtn">+ Add Item</button>
        </div>
        <div class="bd">
          ${items.length ? `
            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="right">Quantity</th>
                  <th class="right">Unit Price</th>
                  <th class="right">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${items.map(item => `
                  <tr>
                    <td>
                      <div style="font-weight:800">${esc(item.item_name)}</div>
                      <div class="muted" style="font-size:12px">${esc(item.description || "")}</div>
                    </td>
                    <td class="right">${badgeForStock(Number(item.quantity), Number(item.reorder_level))}</td>
                    <td class="right muted">‚Ç¨${money(item.unit_price)}</td>
                    <td class="right">
                      <div class="row-actions">
                        <button class="btn mini" data-action="editItem" data-id="${item.item_id}">Edit</button>
                        <button class="btn mini danger" data-action="deleteItem" data-id="${item.item_id}">Delete</button>
                      </div>
                    </td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          ` : `<div class="empty">No items found</div>`}
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h3 id="itemFormTitle">Add Item</h3>
        </div>
        <div class="bd">
          <form id="itemForm">
            <input type="hidden" id="if_id" />
            <div class="field">
              <label>Item Name *</label>
              <input id="if_name" required placeholder="e.g., Coffee Beans 1kg" />
            </div>
            <div class="field">
              <label>Description</label>
              <textarea id="if_desc" placeholder="Optional description"></textarea>
            </div>
            <div class="two-col">
              <div class="field">
                <label>Unit Price *</label>
                <input id="if_price" type="number" min="0" step="0.01" required placeholder="e.g., 12.50" />
              </div>
              <div class="field">
                <label>Reorder Level</label>
                <input id="if_reorder" type="number" min="0" step="1" placeholder="e.g., 10" />
              </div>
            </div>
            <div class="field">
              <label>Notes</label>
              <input id="if_notes" placeholder="Optional notes" />
            </div>

            <div class="split" style="justify-content:flex-end; margin-top:10px;">
              <button type="button" class="btn ghost" id="if_cancel" style="display:none;">Cancel</button>
              <button class="btn primary" type="submit">Save Item</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

  function startAddItem() {
    document.getElementById("itemFormTitle").textContent = "Add Item";
    document.getElementById("if_id").value = "";
    document.getElementById("if_name").value = "";
    document.getElementById("if_desc").value = "";
    document.getElementById("if_price").value = "";
    document.getElementById("if_reorder").value = "10";
    document.getElementById("if_notes").value = "";
    document.getElementById("if_cancel").style.display = "none";
  }

  function loadItemIntoForm(id) {
    const item = state.inventory.find(i => Number(i.item_id) === Number(id));
    if (!item) return;
    document.getElementById("itemFormTitle").textContent = "Edit Item";
    document.getElementById("if_id").value = item.item_id;
    document.getElementById("if_name").value = item.item_name || "";
    document.getElementById("if_desc").value = item.description || "";
    document.getElementById("if_price").value = item.unit_price ?? "";
    document.getElementById("if_reorder").value = item.reorder_level ?? 10;
    document.getElementById("if_notes").value = item.notes || "";
    document.getElementById("if_cancel").style.display = "inline-flex";
  }

  document.getElementById("addItemBtn").onclick = startAddItem;
  document.getElementById("if_cancel").onclick = startAddItem;

  viewEl.querySelectorAll('[data-action="editItem"]').forEach(btn => {
    btn.addEventListener("click", () => loadItemIntoForm(btn.dataset.id));
  });

  viewEl.querySelectorAll('[data-action="deleteItem"]').forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = safeInt(btn.dataset.id, 0);
      if (!id) return;
      if (!confirm("Delete this item?")) return;
      try {
        await deleteInventoryItem(id);
        toast("Deleted", "Item removed");
        await renderInventory(document.getElementById("globalSearch").value);
      } catch (e) {
        toast("Error", e.message);
      }
    });
  });

  document.getElementById("itemForm").onsubmit = async (e) => {
    e.preventDefault();

    const id = safeInt(document.getElementById("if_id").value, 0);
    const name = document.getElementById("if_name").value.trim();
    const desc = document.getElementById("if_desc").value.trim();
    const price = safeFloat(document.getElementById("if_price").value, 0);
    const reorder = safeInt(document.getElementById("if_reorder").value, 10);
    const notes = document.getElementById("if_notes").value.trim();

    if (!name || price <= 0) {
      toast("Error", "Item name and valid price required");
      return;
    }

    try {
      if (id) {
        await updateInventoryItem(id, {
          item_name: name,
          description: desc || null,
          unit_price: price,
          reorder_level: reorder,
          notes: notes || null
        });
        toast("Updated", "Item saved");
      } else {
        await createInventoryItem({
          item_name: name,
          description: desc || null,
          quantity: 0,
          unit_price: price,
          reorder_level: reorder,
          notes: notes || null
        });
        toast("Created", "New item added");
      }

      await renderInventory(document.getElementById("globalSearch").value);
      setTimeout(startAddItem, 50);
    } catch (e2) {
      toast("Error", e2.message);
    }
  };

  startAddItem();
}

async function renderClients() {
  setPage("Clients", "Manage your customers");
  const clients = await loadClients();

  viewEl.innerHTML = `
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <h3>All Clients</h3>
            <div class="sub">${clients.length} clients</div>
          </div>
          <button class="btn primary mini" id="addClientBtn">+ Add Client</button>
        </div>
        <div class="bd">
          ${clients.length ? `
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Contact</th>
                  <th class="right">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${clients.map(c => `
                  <tr>
                    <td>
                      <div style="font-weight:800">${esc(c.client_name)}</div>
                      <div class="muted" style="font-size:12px">${esc(c.notes || "")}</div>
                    </td>
                    <td class="muted">
                      ${c.email ? esc(c.email) : ""}
                      ${c.phone ? " ‚Ä¢ " + esc(c.phone) : ""}
                    </td>
                    <td class="right">
                      <div class="row-actions">
                        <button class="btn mini" data-action="editClient" data-id="${c.client_id}">Edit</button>
                        <button class="btn mini danger" data-action="deleteClient" data-id="${c.client_id}">Delete</button>
                      </div>
                    </td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          ` : `<div class="empty">No clients yet</div>`}
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h3 id="clientFormTitle">Add Client</h3>
        </div>
        <div class="bd">
          <form id="clientForm">
            <input type="hidden" id="cf_id" />
            <div class="field">
              <label>Client Name *</label>
              <input id="cf_name" required placeholder="e.g., Acme Corp" />
            </div>
            <div class="two-col">
              <div class="field">
                <label>Email</label>
                <input id="cf_email" type="email" placeholder="contact@acme.com" />
              </div>
              <div class="field">
                <label>Phone</label>
                <input id="cf_phone" placeholder="+31 20 123 4567" />
              </div>
            </div>
            <div class="field">
              <label>Address</label>
              <input id="cf_address" placeholder="Street, City, Country" />
            </div>
            <div class="field">
              <label>Notes</label>
              <textarea id="cf_notes" placeholder="Optional notes"></textarea>
            </div>

            <div class="split" style="justify-content:flex-end; margin-top:10px;">
              <button type="button" class="btn ghost" id="cf_cancel" style="display:none;">Cancel</button>
              <button class="btn primary" type="submit">Save Client</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

  function startAddClient() {
    document.getElementById("clientFormTitle").textContent = "Add Client";
    document.getElementById("cf_id").value = "";
    document.getElementById("cf_name").value = "";
    document.getElementById("cf_email").value = "";
    document.getElementById("cf_phone").value = "";
    document.getElementById("cf_address").value = "";
    document.getElementById("cf_notes").value = "";
    document.getElementById("cf_cancel").style.display = "none";
  }

  function loadClientIntoForm(id) {
    const c = state.clients.find(x => Number(x.client_id) === Number(id));
    if (!c) return;
    document.getElementById("clientFormTitle").textContent = "Edit Client";
    document.getElementById("cf_id").value = c.client_id;
    document.getElementById("cf_name").value = c.client_name || "";
    document.getElementById("cf_email").value = c.email || "";
    document.getElementById("cf_phone").value = c.phone || "";
    document.getElementById("cf_address").value = c.address || "";
    document.getElementById("cf_notes").value = c.notes || "";
    document.getElementById("cf_cancel").style.display = "inline-flex";
  }

  document.getElementById("addClientBtn").onclick = startAddClient;
  document.getElementById("cf_cancel").onclick = startAddClient;

  viewEl.querySelectorAll('[data-action="editClient"]').forEach(btn => {
    btn.addEventListener("click", () => loadClientIntoForm(btn.dataset.id));
  });

  viewEl.querySelectorAll('[data-action="deleteClient"]').forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = safeInt(btn.dataset.id, 0);
      if (!id) return;
      if (!confirm("Delete this client?")) return;
      try {
        await deleteClient(id);
        toast("Deleted", "Client removed");
        await renderClients();
      } catch (e) {
        toast("Error", e.message);
      }
    });
  });

  document.getElementById("clientForm").onsubmit = async (e) => {
    e.preventDefault();

    const id = safeInt(document.getElementById("cf_id").value, 0);
    const name = document.getElementById("cf_name").value.trim();
    const email = document.getElementById("cf_email").value.trim();
    const phone = document.getElementById("cf_phone").value.trim();
    const address = document.getElementById("cf_address").value.trim();
    const notes = document.getElementById("cf_notes").value.trim();

    if (!name) {
      toast("Error", "Client name required");
      return;
    }

    try {
      if (id) {
        await updateClient(id, {
          client_name: name,
          email: email || null,
          phone: phone || null,
          address: address || null,
          notes: notes || null
        });
        toast("Updated", "Client saved");
      } else {
        await createClient({
          client_name: name,
          email: email || null,
          phone: phone || null,
          address: address || null,
          notes: notes || null
        });
        toast("Created", "New client added");
      }

      await renderClients();
      setTimeout(startAddClient, 50);
    } catch (e2) {
      toast("Error", e2.message);
    }
  };

  startAddClient();
}

async function renderVendors() {
  setPage("Vendors", "Manage your suppliers");
  const vendors = await loadVendors();

  viewEl.innerHTML = `
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <h3>All Vendors</h3>
            <div class="sub">${vendors.length} vendors</div>
          </div>
          <button class="btn primary mini" id="addVendorBtn">+ Add Vendor</button>
        </div>
        <div class="bd">
          ${vendors.length ? `
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Contact</th>
                  <th class="right">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${vendors.map(v => `
                  <tr>
                    <td>
                      <div style="font-weight:800">${esc(v.vendor_name)}</div>
                      <div class="muted" style="font-size:12px">${esc(v.notes || "")}</div>
                    </td>
                    <td class="muted">
                      ${v.email ? esc(v.email) : ""}
                      ${v.phone ? " ‚Ä¢ " + esc(v.phone) : ""}
                    </td>
                    <td class="right">
                      <div class="row-actions">
                        <button class="btn mini" data-action="editVendor" data-id="${v.vendor_id}">Edit</button>
                        <button class="btn mini danger" data-action="deleteVendor" data-id="${v.vendor_id}">Delete</button>
                      </div>
                    </td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          ` : `<div class="empty">No vendors yet</div>`}
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h3 id="vendorFormTitle">Add Vendor</h3>
        </div>
        <div class="bd">
          <form id="vendorForm">
            <input type="hidden" id="vf_id" />
            <div class="field">
              <label>Vendor Name *</label>
              <input id="vf_name" required placeholder="e.g., Supply Co." />
            </div>
            <div class="two-col">
              <div class="field">
                <label>Email</label>
                <input id="vf_email" type="email" placeholder="sales@supplier.com" />
              </div>
              <div class="field">
                <label>Phone</label>
                <input id="vf_phone" placeholder="+31 20 987 6543" />
              </div>
            </div>
            <div class="field">
              <label>Address</label>
              <input id="vf_address" placeholder="Street, City, Country" />
            </div>
            <div class="field">
              <label>Notes</label>
              <textarea id="vf_notes" placeholder="Optional notes"></textarea>
            </div>

            <div class="split" style="justify-content:flex-end; margin-top:10px;">
              <button type="button" class="btn ghost" id="vf_cancel" style="display:none;">Cancel</button>
              <button class="btn primary" type="submit">Save Vendor</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

  function startAddVendor() {
    document.getElementById("vendorFormTitle").textContent = "Add Vendor";
    document.getElementById("vf_id").value = "";
    document.getElementById("vf_name").value = "";
    document.getElementById("vf_email").value = "";
    document.getElementById("vf_phone").value = "";
    document.getElementById("vf_address").value = "";
    document.getElementById("vf_notes").value = "";
    document.getElementById("vf_cancel").style.display = "none";
  }

  function loadVendorIntoForm(id) {
    const v = state.vendors.find(x => Number(x.vendor_id) === Number(id));
    if (!v) return;
    document.getElementById("vendorFormTitle").textContent = "Edit Vendor";
    document.getElementById("vf_id").value = v.vendor_id;
    document.getElementById("vf_name").value = v.vendor_name || "";
    document.getElementById("vf_email").value = v.email || "";
    document.getElementById("vf_phone").value = v.phone || "";
    document.getElementById("vf_address").value = v.address || "";
    document.getElementById("vf_notes").value = v.notes || "";
    document.getElementById("vf_cancel").style.display = "inline-flex";
  }

  document.getElementById("addVendorBtn").onclick = startAddVendor;
  document.getElementById("vf_cancel").onclick = startAddVendor;

  viewEl.querySelectorAll('[data-action="editVendor"]').forEach(btn => {
    btn.addEventListener("click", () => loadVendorIntoForm(btn.dataset.id));
  });

  viewEl.querySelectorAll('[data-action="deleteVendor"]').forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = safeInt(btn.dataset.id, 0);
      if (!id) return;
      if (!confirm("Delete this vendor?")) return;
      try {
        await deleteVendor(id);
        toast("Deleted", "Vendor removed");
        await renderVendors();
      } catch (e) {
        toast("Error", e.message);
      }
    });
  });

  document.getElementById("vendorForm").onsubmit = async (e) => {
    e.preventDefault();

    const id = safeInt(document.getElementById("vf_id").value, 0);
    const name = document.getElementById("vf_name").value.trim();
    const email = document.getElementById("vf_email").value.trim();
    const phone = document.getElementById("vf_phone").value.trim();
    const address = document.getElementById("vf_address").value.trim();
    const notes = document.getElementById("vf_notes").value.trim();

    if (!name) {
      toast("Error", "Vendor name required");
      return;
    }

    try {
      if (id) {
        await updateVendor(id, {
          vendor_name: name,
          email: email || null,
          phone: phone || null,
          address: address || null,
          notes: notes || null
        });
        toast("Updated", "Vendor saved");
      } else {
        await createVendor({
          vendor_name: name,
          email: email || null,
          phone: phone || null,
          address: address || null,
          notes: notes || null
        });
        toast("Created", "New vendor added");
      }

      await renderVendors();
      setTimeout(startAddVendor, 50);
    } catch (e2) {
      toast("Error", e2.message);
    }
  };

  startAddVendor();
}

async function renderSupply() {
  setPage("Supply Orders", "Receive stock from vendors");

  const [orders, vendors, inventory] = await Promise.all([
    loadSupply(),
    loadVendors(),
    loadInventory()
  ]);

  viewEl.innerHTML = `
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <h3>Create Supply Order</h3>
            <div class="sub">Increases inventory</div>
          </div>
          <span class="badge">‚¨áÔ∏è Receipt</span>
        </div>
        <div class="bd">
          <form id="supplyForm">
            <div class="field">
              <label>Vendor (optional)</label>
              <select id="so_vendor">
                <option value="">‚Äî No vendor ‚Äî</option>
                ${vendors.map(v => `<option value="${v.vendor_id}">${esc(v.vendor_name)}</option>`).join("")}
              </select>
            </div>
            <div class="field">
              <label>Notes</label>
              <input id="so_notes" placeholder="e.g., Weekly delivery" />
            </div>

            <div class="hr"></div>
            <h4 style="margin:8px 0;font-size:13px;">Line Items</h4>

            <div class="line-items" id="supplyLines"></div>

            <div class="split" style="margin-top:10px;">
              <button type="button" class="btn" id="addSupplyLineBtn">+ Add Line</button>
              <button class="btn primary" type="submit">Create Order</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <h3>Recent Supply Orders</h3>
            <div class="sub">${orders.length} orders</div>
          </div>
        </div>
        <div class="bd">
          ${orders.length ? `
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Vendor</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                ${orders.slice(0, 10).map(o => `
                  <tr>
                    <td class="muted" style="font-size:11px">${formatWhen(o.order_date)}</td>
                    <td>${esc(o.vendor_name || "‚Äî")}</td>
                    <td class="muted">${esc(o.notes || "")}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          ` : `<div class="empty">No supply orders yet</div>`}
        </div>
      </div>
    </div>
  `;

  const supplyLines = [];
  const linesEl = document.getElementById("supplyLines");

  function addSupplyLine() {
    const lineId = Date.now() + Math.random();
    supplyLines.push(lineId);

    linesEl.insertAdjacentHTML("beforeend", `
      <div class="li" data-line="${lineId}">
        <div class="field">
          <label>Item</label>
          <select class="so_item">
            ${inventory.map(i => `<option value="${i.item_id}">${esc(i.item_name)}</option>`).join("")}
          </select>
        </div>
        <div class="field">
          <label>Quantity</label>
          <input class="so_qty" type="number" min="1" step="1" value="1" />
        </div>
        <div class="field">
          <label>Cost Price</label>
          <input class="so_cost" type="number" min="0" step="0.01" placeholder="5.00" />
        </div>
        <div class="remove">
          <button type="button" class="btn mini danger so_remove">Remove</button>
        </div>
      </div>
    `);

    linesEl.querySelector(`[data-line="${lineId}"] .so_remove`).onclick = () => {
      const idx = supplyLines.indexOf(lineId);
      if (idx >= 0) supplyLines.splice(idx, 1);
      linesEl.querySelector(`[data-line="${lineId}"]`).remove();
    };
  }

  document.getElementById("addSupplyLineBtn").onclick = addSupplyLine;

  document.getElementById("supplyForm").onsubmit = async (e) => {
    e.preventDefault();

    const vendorId = safeInt(document.getElementById("so_vendor").value, 0) || null;
    const notes = document.getElementById("so_notes").value.trim();

    const items = [];
    for (const lineId of supplyLines) {
      const el = linesEl.querySelector(`[data-line="${lineId}"]`);
      if (!el) continue;

      const itemId = safeInt(el.querySelector(".so_item").value, 0);
      const qty = safeInt(el.querySelector(".so_qty").value, 0);
      const cost = safeFloat(el.querySelector(".so_cost").value, 0);

      if (itemId && qty > 0 && cost > 0) {
        items.push({ item_id: itemId, quantity: qty, cost_price: cost, notes: null });
      }
    }

    if (items.length === 0) {
      toast("Error", "Add at least one line item");
      return;
    }

    try {
      await createSupplyOrder({ vendor_id: vendorId, notes: notes || null, items });
      toast("Created", "Supply order added, inventory updated");
      await renderSupply();
    } catch (err) {
      toast("Error", err.message);
    }
  };

  if (inventory.length) addSupplyLine();
}

async function renderSales() {
  setPage("Sales", "Create sales transactions");

  const [sales, clients, inventory] = await Promise.all([
    loadSales(),
    loadClients(),
    loadInventory()
  ]);

  viewEl.innerHTML = `
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <h3>Create Sale</h3>
            <div class="sub">Decreases inventory</div>
          </div>
          <span class="badge">‚¨ÜÔ∏è Sale</span>
        </div>
        <div class="bd">
          <form id="saleForm">
            <div class="field">
              <label>Client (optional)</label>
              <select id="s_client">
                <option value="">‚Äî Walk-in customer ‚Äî</option>
                ${clients.map(c => `<option value="${c.client_id}">${esc(c.client_name)}</option>`).join("")}
              </select>
            </div>
            <div class="field">
              <label>Notes</label>
              <input id="s_notes" placeholder="e.g., Cash sale" />
            </div>

            <div class="hr"></div>
            <h4 style="margin:8px 0;font-size:13px;">Line Items</h4>

            <div class="line-items" id="saleLines"></div>

            <div class="split" style="margin-top:10px;">
              <button type="button" class="btn" id="addSaleLineBtn">+ Add Line</button>
              <button class="btn primary" type="submit">Create Sale</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <h3>Recent Sales</h3>
            <div class="sub">${sales.length} sales</div>
          </div>
        </div>
        <div class="bd">
          ${sales.length ? `
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Client</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                ${sales.slice(0, 10).map(s => `
                  <tr>
                    <td class="muted" style="font-size:11px">${formatWhen(s.sale_date)}</td>
                    <td>${esc(s.client_name || "Walk-in")}</td>
                    <td class="muted">${esc(s.notes || "")}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          ` : `<div class="empty">No sales yet</div>`}
        </div>
      </div>
    </div>
  `;

  const saleLines = [];
  const linesEl = document.getElementById("saleLines");

  function addSaleLine() {
    const lineId = Date.now() + Math.random();
    saleLines.push(lineId);

    linesEl.insertAdjacentHTML("beforeend", `
      <div class="li" data-line="${lineId}">
        <div class="field">
          <label>Item</label>
          <select class="s_item">
            ${inventory.map(i => `<option value="${i.item_id}">${esc(i.item_name)} (stock: ${i.quantity})</option>`).join("")}
          </select>
        </div>
        <div class="field">
          <label>Quantity</label>
          <input class="s_qty" type="number" min="1" step="1" value="1" />
        </div>
        <div class="field">
          <label>Unit Price</label>
          <input class="s_price" type="number" min="0" step="0.01" placeholder="12.50" />
        </div>
        <div class="remove">
          <button type="button" class="btn mini danger s_remove">Remove</button>
        </div>
      </div>
    `);

    const row = linesEl.querySelector(`[data-line="${lineId}"]`);
    row.querySelector(".s_remove").onclick = () => {
      const idx = saleLines.indexOf(lineId);
      if (idx >= 0) saleLines.splice(idx, 1);
      row.remove();
    };

    // Auto-fill price from inventory
    const itemSelect = row.querySelector(".s_item");
    const priceInput = row.querySelector(".s_price");
    itemSelect.onchange = () => {
      const itemId = safeInt(itemSelect.value, 0);
      const item = inventory.find(i => Number(i.item_id) === Number(itemId));
      if (item) priceInput.value = item.unit_price;
    };
    if (inventory.length) itemSelect.onchange();
  }

  document.getElementById("addSaleLineBtn").onclick = addSaleLine;

  document.getElementById("saleForm").onsubmit = async (e) => {
    e.preventDefault();

    const clientId = safeInt(document.getElementById("s_client").value, 0) || null;
    const notes = document.getElementById("s_notes").value.trim();

    const items = [];
    for (const lineId of saleLines) {
      const el = linesEl.querySelector(`[data-line="${lineId}"]`);
      if (!el) continue;

      const itemId = safeInt(el.querySelector(".s_item").value, 0);
      const qty = safeInt(el.querySelector(".s_qty").value, 0);
      const price = safeFloat(el.querySelector(".s_price").value, 0);

      if (itemId && qty > 0 && price > 0) {
        items.push({ item_id: itemId, quantity: qty, unit_price: price, notes: null });
      }
    }

    if (items.length === 0) {
      toast("Error", "Add at least one line item");
      return;
    }

    try {
      await createSale({ client_id: clientId, notes: notes || null, items });
      toast("Created", "Sale completed, inventory updated");
      await renderSales();
    } catch (err) {
      toast("Error", err.message);
    }
  };

  if (inventory.length) addSaleLine();
}

async function renderReports() {
  setPage("Reports", "Sales and inventory analytics");

  // Prefer server-side computed report data (matches DB)
  const r = await loadReports();

  // Support either flat or nested response
  const inv = r.inventory || r;
  const tx = r.transactions || r;

  // Reasonable defaults if server returns only one section
  const totalValue = Number(inv.total_value ?? inv.total_inventory_value ?? 0);
  const totalItems = Number(inv.total_items ?? inv.total_units ?? 0);
  const lowStockCount = Number(inv.low_stock_count ?? 0);

  const salesRevenue = Number(tx.sales_revenue ?? 0);
  const salesCount = Number(tx.sales_count ?? 0);
  const supplyCost = Number(tx.supply_cost ?? 0);
  const supplyCount = Number(tx.supply_count ?? 0);
  const grossMargin = Number(tx.gross_margin ?? (salesRevenue - supplyCost));

  viewEl.innerHTML = `
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <h3>Inventory Summary</h3>
            <div class="sub">Current stock metrics</div>
          </div>
        </div>
        <div class="bd">
          <div class="kpi-row" style="grid-template-columns:1fr 1fr">
            <div class="kpi">
              <div class="label">Total Inventory Value</div>
              <div class="value">‚Ç¨${money(totalValue)}</div>
              ${lowStockCount ? `<div class="hint">${lowStockCount} low stock items</div>` : ``}
            </div>
            <div class="kpi">
              <div class="label">Total Units</div>
              <div class="value">${safeInt(totalItems, 0)}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <h3>Transaction Summary</h3>
            <div class="sub">All-time totals</div>
          </div>
        </div>
        <div class="bd">
          <div class="kpi-row" style="grid-template-columns:1fr 1fr">
            <div class="kpi">
              <div class="label">Total Sales Revenue</div>
              <div class="value">‚Ç¨${money(salesRevenue)}</div>
              <div class="hint">${safeInt(salesCount, 0)} transactions</div>
            </div>
            <div class="kpi">
              <div class="label">Total Supply Cost</div>
              <div class="value">‚Ç¨${money(supplyCost)}</div>
              <div class="hint">${safeInt(supplyCount, 0)} orders</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="kpi">
            <div class="label">Gross Margin (Est.)</div>
            <div class="value">‚Ç¨${money(grossMargin)}</div>
            <div class="hint">Sales revenue minus supply costs</div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============================
// Demo buttons: Seed & Reset (now via API)
// ============================

document.getElementById("seedBtn").onclick = async () => {
  // Keep behavior: seed demo data, but now it persists in SQLite.
  try {
    if (!confirm("Load demo data into SQLite?")) return;

    // Load current to avoid duplicates by name (simple)
    const [inv, clients, vendors] = await Promise.all([loadInventory(), loadClients(), loadVendors()]);

    const hasInv = (name) => inv.some(i => String(i.item_name).toLowerCase() === name.toLowerCase());
    const hasClient = (name) => clients.some(c => String(c.client_name).toLowerCase() === name.toLowerCase());
    const hasVendor = (name) => vendors.some(v => String(v.vendor_name).toLowerCase() === name.toLowerCase());

    if (!hasInv("Coffee Beans 1kg")) await createInventoryItem({ item_name: "Coffee Beans 1kg", description: "Arabica blend", quantity: 0, unit_price: 19.50, reorder_level: 5, notes: null });
    if (!hasInv("Sugar 1kg")) await createInventoryItem({ item_name: "Sugar 1kg", description: "White sugar", quantity: 0, unit_price: 2.40, reorder_level: 10, notes: null });
    if (!hasInv("Milk 1L")) await createInventoryItem({ item_name: "Milk 1L", description: "Fresh milk", quantity: 0, unit_price: 1.60, reorder_level: 20, notes: null });

    if (!hasClient("Caf√© Central")) await createClient({ client_name: "Caf√© Central", email: "cafe@central.com", phone: "+31 20 123 4567", address: "Amsterdam", notes: null });
    if (!hasClient("Bakery Bliss")) await createClient({ client_name: "Bakery Bliss", email: "info@bakery.com", phone: "+31 20 987 6543", address: "Rotterdam", notes: null });

    if (!hasVendor("Global Coffee Supply")) await createVendor({ vendor_name: "Global Coffee Supply", email: "sales@globalcoffee.com", phone: "+31 20 111 2222", address: "Utrecht", notes: null });

    toast("Loaded", "Demo data added to SQLite");
    await goto("dashboard");
  } catch (e) {
    toast("Error", e.message);
  }
};

document.getElementById("resetBtn").onclick = async () => {
  // No server endpoint for wipe. We do it client-side by deleting records.
  // Order matters due to FK constraints: delete sales & supply first, then masters.
  try {
    if (!confirm("This will delete ALL data in SQLite. Continue?")) return;

    // Delete sales
    const sales = await loadSales();
    for (const s of sales) {
      // backend has DELETE /api/sales/:id per README, but your routes may or may not.
      // If you don't have it, comment this block and add the route.
      await apiFetch(`/sales/${s.sale_id}`, { method: "DELETE" });
    }

    // Delete supply
    const supply = await loadSupply();
    for (const o of supply) {
      await apiFetch(`/supply/${o.supply_order_id}`, { method: "DELETE" });
    }

    // Delete inventory, clients, vendors
    const inv = await loadInventory();
    for (const i of inv) await deleteInventoryItem(i.item_id);

    const clients = await loadClients();
    for (const c of clients) await deleteClient(c.client_id);

    const vendors = await loadVendors();
    for (const v of vendors) await deleteVendor(v.vendor_id);

    toast("Reset", "All data cleared from SQLite");
    await goto("dashboard");
  } catch (e) {
    toast("Error", e.message);
  }
};

// ============================
// Init
// ============================

async function init() {
  await refreshHealth();
  await goto("dashboard");
}

init();
</script>

</body>
</html>
